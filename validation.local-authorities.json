{"version":3,"kind":"Notebook","sha256":"6485305cbf839aa4a7603825b9e52ce428be2f6babbfc864f918003f31cbb8c9","slug":"validation.local-authorities","location":"/validation/local_authorities.ipynb","dependencies":[],"frontmatter":{"title":"Local authority dataset validation","content_includes_title":true,"kernelspec":{"name":"python3","display_name":"base","language":"python"},"authors":[{"nameParsed":{"given":"PolicyEngine","family":"Team","literal":"PolicyEngine Team"},"name":"PolicyEngine Team","id":"contributors-myst-generated-uid-0"}],"github":"https://github.com/policyengine/policyengine-uk-data","copyright":"2024","numbering":{"title":{"offset":1}},"source_url":"https://github.com/policyengine/policyengine-uk-data/blob/main/docs/validation/local_authorities.ipynb","edit_url":"https://github.com/policyengine/policyengine-uk-data/edit/main/docs/validation/local_authorities.ipynb","exports":[{"format":"ipynb","filename":"local_authorities.ipynb","url":"/policyengine-uk-data/build/local_authorities-5977cf0ae09b16968e56929aeebb5e29.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Local authority dataset validation","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HFJQ2TIpEF"}],"identifier":"local-authority-dataset-validation","label":"Local authority dataset validation","html_id":"local-authority-dataset-validation","implicit":true,"key":"MMDL4JVwBy"}],"key":"BHJNJ3C4e2"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from policyengine_uk import Microsimulation\nimport pandas as pd\nimport h5py\nimport numpy as np\nimport sys\nfrom itables import init_notebook_mode\nimport itables.options as opt\nfrom pathlib import Path\nfrom policyengine_uk_data.storage import STORAGE_FOLDER\nfrom policyengine_uk_data.utils.huggingface import download\n\nopt.maxBytes = \"1MB\"\ninit_notebook_mode(all_interactive=True)\n\nREPO = Path(\".\").resolve().parent\n\nweights_file_path = STORAGE_FOLDER / \"local_authority_weights.h5\"\nconstituency_names_file_path = download(\n    repo=\"policyengine/policyengine-uk-data\",\n    repo_filename=\"local_authorities_2021.csv\",\n    local_folder=None,\n    version=None,\n)\nconstituencies_2024 = pd.read_csv(constituency_names_file_path)\n\nwith h5py.File(weights_file_path, \"r\") as f:\n    weights = f[str(2025)][...]\n\nbaseline = Microsimulation()\nhousehold_weights = baseline.calculate(\"household_weight\", 2025).values\n\nfrom policyengine_uk_data.datasets.frs.local_areas.local_authorities.loss import create_local_authority_target_matrix, create_national_target_matrix\nfrom policyengine_uk_data.datasets import EnhancedFRS_2022_23\n\nlocal_authority_target_matrix, local_authority_actuals, _ = create_local_authority_target_matrix(EnhancedFRS_2022_23, 2025, None)\nnational_target_matrix, national_actuals = create_national_target_matrix(EnhancedFRS_2022_23, 2025, None)\n\nlocal_authority_wide = weights @ local_authority_target_matrix\nlocal_authority_wide.index = constituencies_2024.code.values\nlocal_authority_wide[\"name\"] = constituencies_2024.name.values\n\nlocal_authority_results = pd.melt(local_authority_wide.reset_index(), id_vars=[\"index\", \"name\"], var_name=\"variable\", value_name=\"value\")\n\nlocal_authority_actuals.index = constituencies_2024.code.values\nlocal_authority_actuals[\"name\"] = constituencies_2024.name.values\nlocal_authority_actuals_long = pd.melt(local_authority_actuals.reset_index(), id_vars=[\"index\", \"name\"], var_name=\"variable\", value_name=\"value\")\n\nlocal_authority_target_validation = pd.merge(local_authority_results, local_authority_actuals_long, on=[\"index\", \"variable\"], suffixes=(\"_target\", \"_actual\"))\nlocal_authority_target_validation.drop(\"name_actual\", axis=1, inplace=True)\nlocal_authority_target_validation.columns = [\"index\", \"name\", \"metric\", \"estimate\", \"target\"]\n\nlocal_authority_target_validation[\"error\"] = local_authority_target_validation[\"estimate\"] - local_authority_target_validation[\"target\"]\nlocal_authority_target_validation[\"abs_error\"] = local_authority_target_validation[\"error\"].abs()\nlocal_authority_target_validation[\"rel_abs_error\"] = local_authority_target_validation[\"abs_error\"] / local_authority_target_validation[\"target\"]","key":"SC68g3TTGx"},{"type":"outputs","id":"jZjfod5rWcYYA3JZKrcYW","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"text/html":{"content":"<script>\n    let is_dark_theme = function () {\n        // Jupyter Lab\n        if ('jpThemeLight' in document.body.dataset)\n            return (document.body.dataset.jpThemeLight === \"false\");\n\n        // VS Code\n        if ('vscodeThemeKind' in document.body.dataset)\n            return document.body.dataset.vscodeThemeKind.includes('dark');\n\n        // Jupyter Book\n        if ('theme' in document.documentElement.dataset)\n            return document.documentElement.dataset.theme.includes('dark');\n\n        // Default\n        return window.matchMedia('(prefers-color-scheme: dark)').matches;\n    }\n\n    if (is_dark_theme()) {\n        document.documentElement.classList.add('dark');\n    }\n    else {\n        document.documentElement.classList.remove('dark');\n    }\n</script>\n","content_type":"text/html"},"text/plain":{"content":"<IPython.core.display.HTML object>","content_type":"text/plain"}}},"children":[],"key":"h6oDF6KYBj"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"text/html":{"content_type":"text/html","hash":"77b6e5b56b91d09b209d30a7623e5495","path":"/policyengine-uk-data/build/77b6e5b56b91d09b209d30a7623e5495.html"},"text/plain":{"content":"<IPython.core.display.HTML object>","content_type":"text/plain"}}},"children":[],"key":"gYYkWuXTM3"}],"key":"QOFpW6IjpZ"}],"key":"H4mSO0n6To"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Calibration check","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gdVL8pZNwF"}],"identifier":"calibration-check","label":"Calibration check","html_id":"calibration-check","implicit":true,"key":"KES9eUh6M4"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Looking at the sorted validation results by relative absolute error shows how well our calibrated weights perform against the actual target statistics across UK local authorities under 2021 boundaries. The table reveals the accuracy of our estimates, from the closest matches to the largest discrepancies, where a lower relative error indicates better calibration performance.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"mm5iKYWEe9"}],"key":"rGYJ43Y1gq"}],"key":"Uut9ftgf6j"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"local_authority_target_validation.sort_values(\"rel_abs_error\")","key":"tSR7RztbkH"},{"type":"outputs","id":"ieLPFBaStsZg4lIcX4SHz","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":3,"metadata":{},"data":{"text/html":{"content_type":"text/html","hash":"2425da5ae329d97dfd6c3845ea7547f7","path":"/policyengine-uk-data/build/2425da5ae329d97dfd6c3845ea7547f7.html"},"text/plain":{"content":"          index                    name  ...     abs_error  rel_abs_error\n1024  N09000009              Mid Ulster  ...  7.786641e-01       0.000036\n3485  E08000019               Sheffield  ...  1.751454e+00       0.000039\n2392  E08000006                 Salford  ...  1.939367e+00       0.000058\n174   E07000175     Newark and Sherwood  ...  2.067212e+05       0.000072\n6517  E06000040  Windsor and Maidenhead  ...  6.069600e-01       0.000077\n...         ...                     ...  ...           ...            ...\n4998  S12000023          Orkney Islands  ...  3.384977e+06       2.587359\n4943  E09000001          City of London  ...  3.397485e+06       2.596920\n5000  S12000027        Shetland Islands  ...  3.436770e+06       2.626947\n1129  E06000053         Isles of Scilly  ...  5.483983e+02       2.654006\n1849  E06000053         Isles of Scilly  ...  6.821887e+02       2.965500\n\n[7920 rows x 8 columns]","content_type":"text/plain"}}},"children":[],"key":"GwmnB8cLCx"}],"key":"ESRZc1ks9g"}],"key":"u4JazzG6UI"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"national_performance = household_weights @ national_target_matrix\nnational_target_validation = pd.DataFrame({\"metric\": national_performance.index, \"estimate\": national_performance.values})\nnational_target_validation[\"target\"] = national_actuals.values\n\nnational_target_validation[\"error\"] = national_target_validation[\"estimate\"] - national_target_validation[\"target\"]\nnational_target_validation[\"abs_error\"] = national_target_validation[\"error\"].abs()\nnational_target_validation[\"rel_abs_error\"] = national_target_validation[\"abs_error\"] / national_target_validation[\"target\"]","key":"zaLiaEmyKf"},{"type":"outputs","id":"6kC29iw8ACZoR13tMMMER","children":[],"key":"D4hppe532x"}],"key":"PRRJjab0bQ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"The table below shows the relative absolute error for each calibration target at the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gaILjHspC3"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"national level","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ofv7lZnW6M"}],"key":"yA1gddy1Hy"},{"type":"text","value":", sorted from the closest matches to the largest discrepancies.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CbKccQpk2N"}],"key":"EtfwghPBp9"}],"key":"RMSVeGOgxI"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"national_target_validation.sort_values(\"rel_abs_error\")","key":"QEMYKBri1n"},{"type":"outputs","id":"daZRJiyXCRi1M1_r1upEJ","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":4,"metadata":{},"data":{"text/html":{"content_type":"text/html","hash":"2861a17e5d36de43e6971d293a74256c","path":"/policyengine-uk-data/build/2861a17e5d36de43e6971d293a74256c.html"},"text/plain":{"content":"                                                metric      estimate  \\\n32                                     obr/tax_credits  8.095053e+07   \n68                         ons/west_midlands_age_10_19  7.429357e+05   \n123                             ons/scotland_age_20_29  7.089335e+05   \n324  hmrc/self_employment_income_count_income_band_...  3.716194e+06   \n301  hmrc/property_income_income_band_53_500_000.0_...  5.764153e+08   \n..                                                 ...           ...   \n313  hmrc/private_pension_income_income_band_54_1_0...  1.923202e+08   \n297  hmrc/state_pension_income_band_53_500_000.0_to...  4.931677e+07   \n38                           obr/winter_fuel_allowance  4.894976e+08   \n18                     obr/winter_fuel_allowance_count  1.991194e+06   \n25                                  obr/domestic_rates  0.000000e+00   \n\n           target         error     abs_error  rel_abs_error  \n32  -1.000000e+08  1.809505e+08  1.809505e+08      -1.809505  \n68   7.430000e+05 -6.430588e+01  6.430588e+01       0.000087  \n123  7.090000e+05 -6.650023e+01  6.650023e+01       0.000094  \n324  3.716570e+06 -3.759030e+02  3.759030e+02       0.000101  \n301  5.761748e+08  2.405176e+05  2.405176e+05       0.000417  \n..            ...           ...           ...            ...  \n313  3.732529e+08 -1.809327e+08  1.809327e+08       0.484746  \n297  1.058525e+08 -5.653571e+07  5.653571e+07       0.534099  \n38   1.900000e+09 -1.410502e+09  1.410502e+09       0.742370  \n18   1.100000e+07 -9.008806e+06  9.008806e+06       0.818982  \n25   4.000000e+08 -4.000000e+08  4.000000e+08       1.000000  \n\n[335 rows x 6 columns]","content_type":"text/plain"}}},"children":[],"key":"EZFKyu2PLQ"}],"key":"LAXr3EdKbK"}],"key":"r4j4oCibmA"}],"key":"wpauI324Bl"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Constituency dataset validation","url":"/validation/constituencies","group":"PolicyEngine UK data"},"next":{"title":"Pension contributions","url":"/pension-contributions","group":"PolicyEngine UK data"}}},"domain":"http://localhost:3000"}