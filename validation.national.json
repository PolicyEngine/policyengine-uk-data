{"version":3,"kind":"Notebook","sha256":"a49f3055b3c139be7c16557484695ace2fc01db7cb1f29d17cae15a29fe5d0af","slug":"validation.national","location":"/validation/national.ipynb","dependencies":[],"frontmatter":{"title":"National dataset validation","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"base","language":"python"},"authors":[{"nameParsed":{"given":"PolicyEngine","family":"Team","literal":"PolicyEngine Team"},"name":"PolicyEngine Team","id":"contributors-myst-generated-uid-0"}],"github":"https://github.com/policyengine/policyengine-uk-data","copyright":"2024","numbering":{"title":{"offset":1}},"source_url":"https://github.com/policyengine/policyengine-uk-data/blob/main/docs/validation/national.ipynb","edit_url":"https://github.com/policyengine/policyengine-uk-data/edit/main/docs/validation/national.ipynb","exports":[{"format":"ipynb","filename":"national.ipynb","url":"/policyengine-uk-data/build/national-949c551ec58b60fdd3e4ef02257617a1.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from policyengine_uk_data import EnhancedFRS_2022_23, FRS_2022_23, SPI_2020_21\nfrom policyengine_uk_data.utils.loss import get_loss_results\nimport pandas as pd\nfrom itables import init_notebook_mode\nimport itables.options as opt\nopt.maxBytes = \"1MB\"\n\ninit_notebook_mode(all_interactive=True)\n\ndef get_validation():\n    df = pd.DataFrame()\n    for dataset in [FRS_2022_23, EnhancedFRS_2022_23]:\n        for year in range(2025, 2029):\n            loss_results = get_loss_results(dataset, year)\n            loss_results[\"time_period\"] = year\n            loss_results[\"dataset\"] = dataset.label\n            df = pd.concat([df, loss_results])\n    df = df.reset_index(drop=True)\n    return df\n\ndf = get_validation()\ntruth_df = df[df.dataset == df.dataset.unique()[0]].reset_index()\ntruth_df[\"estimate\"] = truth_df[\"target\"]\ntruth_df[\"error\"] = truth_df[\"estimate\"] - truth_df[\"target\"]\ntruth_df[\"abs_error\"] = truth_df[\"error\"].abs()\ntruth_df[\"rel_error\"] = truth_df[\"error\"] / truth_df[\"target\"]\ntruth_df[\"abs_rel_error\"] = truth_df[\"rel_error\"].abs()\ntruth_df[\"dataset\"] = \"Official\"\ndf = pd.concat([df, truth_df]).reset_index(drop=True)","key":"zpdkvmZXAT"},{"type":"outputs","id":"_rHoV3RHiC_YoyfzVVU2e","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"text/html":{"content":"<script>\n    let is_dark_theme = function () {\n        // Jupyter Lab\n        if ('jpThemeLight' in document.body.dataset)\n            return (document.body.dataset.jpThemeLight === \"false\");\n\n        // VS Code\n        if ('vscodeThemeKind' in document.body.dataset)\n            return document.body.dataset.vscodeThemeKind.includes('dark');\n\n        // Jupyter Book\n        if ('theme' in document.documentElement.dataset)\n            return document.documentElement.dataset.theme.includes('dark');\n\n        // Default\n        return window.matchMedia('(prefers-color-scheme: dark)').matches;\n    }\n\n    if (is_dark_theme()) {\n        document.documentElement.classList.add('dark');\n    }\n    else {\n        document.documentElement.classList.remove('dark');\n    }\n</script>\n","content_type":"text/html"},"text/plain":{"content":"<IPython.core.display.HTML object>","content_type":"text/plain"}}},"children":[],"key":"dNBrfTeA3Z"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"text/html":{"content_type":"text/html","hash":"1c0040261338602e496decb4a8f6078e","path":"/policyengine-uk-data/build/1c0040261338602e496decb4a8f6078e.html"},"text/plain":{"content":"<IPython.core.display.HTML object>","content_type":"text/plain"}}},"children":[],"key":"Jd69sH8Eb6"}],"key":"oQZeUT3jiP"}],"key":"TJVZ5aBWqi"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Calibration check: the table below shows how both the original and enhanced FRS datasets compare to over 2,000 official statistics (which the EFRS was explicitly calibrated to hit) from the OBR, DWP and HMRC.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Rox7Bm3TRE"}],"key":"wn5FawGT2U"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Since the EFRS is calibrated to these statistics, high performance is expected and achieved.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"PnucwrLM4m"}],"key":"N3iYfsjmoG"},{"type":"heading","depth":2,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Full results","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"gwnkAuDLJX"}],"identifier":"full-results","label":"Full results","html_id":"full-results","implicit":true,"key":"BLklMSVrRY"}],"key":"m0KtfxjgDp"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"df.drop(columns=[\"index\"])","key":"mKJ4yVW8dH"},{"type":"outputs","id":"NR1JbkXKTK__CfxoGndkZ","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":2,"metadata":{},"data":{"text/html":{"content_type":"text/html","hash":"3921464c07e5efa46dd5d1ab87977e4a","path":"/policyengine-uk-data/build/3921464c07e5efa46dd5d1ab87977e4a.html"},"text/plain":{"content":"                                                   name      estimate  \\\n0                              obr/attendance_allowance  3.620932e+09   \n1                                  obr/carers_allowance  2.809091e+09   \n2                                               obr/dla  3.889957e+09   \n3                                               obr/esa  7.209292e+09   \n4                                       obr/esa_contrib  1.777680e+09   \n...                                                 ...           ...   \n7009  hmrc/property_income_count_income_band_97_12_5...  2.362992e+06   \n7010  hmrc/savings_interest_income_income_band_97_12...  4.164107e+09   \n7011  hmrc/savings_interest_income_count_income_band...  1.176774e+07   \n7012  hmrc/dividend_income_income_band_97_12_570.0_t...  1.200313e+11   \n7013  hmrc/dividend_income_count_income_band_97_12_5...  4.006604e+06   \n\n            target         error     abs_error  rel_error  abs_rel_error  \\\n0     5.700000e+09 -2.079068e+09  2.079068e+09  -0.364749       0.364749   \n1     3.300000e+09 -4.909088e+08  4.909088e+08  -0.148760       0.148760   \n2     6.000000e+09 -2.110043e+09  2.110043e+09  -0.351674       0.351674   \n3     1.210000e+10 -4.890708e+09  4.890708e+09  -0.404191       0.404191   \n4     4.500000e+09 -2.722320e+09  2.722320e+09  -0.604960       0.604960   \n...            ...           ...           ...        ...            ...   \n7009  2.362992e+06  0.000000e+00  0.000000e+00   0.000000       0.000000   \n7010  4.164107e+09  0.000000e+00  0.000000e+00   0.000000       0.000000   \n7011  1.176774e+07  0.000000e+00  0.000000e+00   0.000000       0.000000   \n7012  1.200313e+11  0.000000e+00  0.000000e+00   0.000000       0.000000   \n7013  4.006604e+06  0.000000e+00  0.000000e+00   0.000000       0.000000   \n\n      time_period        dataset  \n0            2022  FRS (2022-23)  \n1            2022  FRS (2022-23)  \n2            2022  FRS (2022-23)  \n3            2022  FRS (2022-23)  \n4            2022  FRS (2022-23)  \n...           ...            ...  \n7009         2028       Official  \n7010         2028       Official  \n7011         2028       Official  \n7012         2028       Official  \n7013         2028       Official  \n\n[7014 rows x 9 columns]","content_type":"text/plain"}}},"children":[],"key":"qmz79VzkBX"}],"key":"lLMlvhX2It"}],"key":"ZUNAh8DmQ1"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Comparisons","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MJfD6nt6jv"}],"identifier":"comparisons","label":"Comparisons","html_id":"comparisons","implicit":true,"key":"TEqv5RwNxC"}],"key":"b4wnxwUB5x"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"merged = pd.merge(\n    df[df.dataset == \"FRS (2022-23)\"],\n    df[df.dataset == \"Enhanced FRS (2022-23)\"],\n    on=[\"time_period\", \"name\"],\n    suffixes=(\"_frs\", \"_efrs\"),\n)\nmerged[\"rel_error_change_under_efrs\"] = merged[\"abs_rel_error_efrs\"] - merged[\"abs_rel_error_frs\"]\n# Sort columns\nmerged = merged[\n    [\n        \"name\",\n        \"time_period\",\n        \"target_frs\",\n        \"estimate_frs\",\n        \"estimate_efrs\",\n        \"error_frs\",\n        \"error_efrs\",\n        \"abs_error_frs\",\n        \"abs_error_efrs\",\n        \"rel_error_frs\",\n        \"rel_error_efrs\",\n        \"abs_rel_error_frs\",\n        \"abs_rel_error_efrs\",\n        \"rel_error_change_under_efrs\",\n    ]\n]\nmerged","key":"GRrGyDJ6XF"},{"type":"outputs","id":"eXhqcfQAGtynVOnWehS3l","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":3,"metadata":{},"data":{"text/html":{"content_type":"text/html","hash":"f0fb07c68960ae84ddcd1fe14633c133","path":"/policyengine-uk-data/build/f0fb07c68960ae84ddcd1fe14633c133.html"},"text/plain":{"content":"                                                   name  time_period  \\\n0                              obr/attendance_allowance         2022   \n1                                  obr/carers_allowance         2022   \n2                                               obr/dla         2022   \n3                                               obr/esa         2022   \n4                                       obr/esa_contrib         2022   \n...                                                 ...          ...   \n2333  hmrc/property_income_count_income_band_97_12_5...         2028   \n2334  hmrc/savings_interest_income_income_band_97_12...         2028   \n2335  hmrc/savings_interest_income_count_income_band...         2028   \n2336  hmrc/dividend_income_income_band_97_12_570.0_t...         2028   \n2337  hmrc/dividend_income_count_income_band_97_12_5...         2028   \n\n        target_frs  estimate_frs  estimate_efrs     error_frs    error_efrs  \\\n0     5.700000e+09  3.620932e+09   6.027340e+09 -2.079068e+09  3.273395e+08   \n1     3.300000e+09  2.809091e+09   3.823339e+09 -4.909088e+08  5.233393e+08   \n2     6.000000e+09  3.889957e+09   6.276854e+09 -2.110043e+09  2.768544e+08   \n3     1.210000e+10  7.209292e+09   1.287792e+10 -4.890708e+09  7.779178e+08   \n4     4.500000e+09  1.777680e+09   4.733142e+09 -2.722320e+09  2.331423e+08   \n...            ...           ...            ...           ...           ...   \n2333  2.362992e+06  1.786734e+06   2.495508e+06 -5.762585e+05  1.325162e+05   \n2334  4.164107e+09  6.704610e+09   4.459873e+09  2.540503e+09  2.957657e+08   \n2335  1.176774e+07  1.615525e+07   1.260677e+07  4.387506e+06  8.390220e+05   \n2336  1.200313e+11  1.085593e+10   1.250550e+11 -1.091754e+11  5.023635e+09   \n2337  4.006604e+06  2.786889e+06   4.229811e+06 -1.219715e+06  2.232069e+05   \n\n      abs_error_frs  abs_error_efrs  rel_error_frs  rel_error_efrs  \\\n0      2.079068e+09    3.273395e+08      -0.364749        0.057428   \n1      4.909088e+08    5.233393e+08      -0.148760        0.158588   \n2      2.110043e+09    2.768544e+08      -0.351674        0.046142   \n3      4.890708e+09    7.779178e+08      -0.404191        0.064291   \n4      2.722320e+09    2.331423e+08      -0.604960        0.051809   \n...             ...             ...            ...             ...   \n2333   5.762585e+05    1.325162e+05      -0.243868        0.056080   \n2334   2.540503e+09    2.957657e+08       0.610096        0.071027   \n2335   4.387506e+06    8.390220e+05       0.372842        0.071298   \n2336   1.091754e+11    5.023635e+09      -0.909558        0.041853   \n2337   1.219715e+06    2.232069e+05      -0.304426        0.055710   \n\n      abs_rel_error_frs  abs_rel_error_efrs  rel_error_change_under_efrs  \n0              0.364749            0.057428                    -0.307321  \n1              0.148760            0.158588                     0.009827  \n2              0.351674            0.046142                    -0.305531  \n3              0.404191            0.064291                    -0.339900  \n4              0.604960            0.051809                    -0.553151  \n...                 ...                 ...                          ...  \n2333           0.243868            0.056080                    -0.187788  \n2334           0.610096            0.071027                    -0.539068  \n2335           0.372842            0.071298                    -0.301543  \n2336           0.909558            0.041853                    -0.867705  \n2337           0.304426            0.055710                    -0.248716  \n\n[2338 rows x 14 columns]","content_type":"text/plain"}}},"children":[],"key":"HH00ZV0Npz"}],"key":"oaS0bzQrV1"}],"key":"rS2mltfoOh"}],"key":"mh1VaJuptA"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Validation","url":"/validation","group":"PolicyEngine UK data"},"next":{"title":"Constituency dataset validation","url":"/validation/constituencies","group":"PolicyEngine UK data"}}},"domain":"http://localhost:3000"}