{"version":2,"kind":"Notebook","sha256":"4858eda65b75476210e5abdbacff996ceb86b961ac5cb048e8a53e7ccd540418","slug":"constituency-methodology","location":"/constituency_methodology.ipynb","dependencies":[],"frontmatter":{"title":"Constituency methodology","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"base","language":"python"},"authors":[{"nameParsed":{"given":"PolicyEngine","family":"Team","literal":"PolicyEngine Team"},"name":"PolicyEngine Team","id":"contributors-myst-generated-uid-0"}],"github":"https://github.com/policyengine/policyengine-uk-data","copyright":"2024","source_url":"https://github.com/policyengine/policyengine-uk-data/blob/main/docs/constituency_methodology.ipynb","edit_url":"https://github.com/policyengine/policyengine-uk-data/edit/main/docs/constituency_methodology.ipynb","thumbnail":"/policyengine-uk-data/build/nomis_screenshot1-cd66b5d52b7084eee8b6167f26f0ee13.png","exports":[{"format":"ipynb","filename":"constituency_methodology.ipynb","url":"/policyengine-uk-data/build/constituency_methodo-d631fd0e75b2e05b58669ba04da75231.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Introduction","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nRDoDZlYkf"}],"identifier":"introduction","label":"Introduction","html_id":"introduction","implicit":true,"key":"l5gXqCz60L"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"When policy changes in the UK - taxes, benefits, or public spending - it affects places and people differently. PolicyEngine UK builds tools to analyze incomes, jobs, and population patterns in each constituency. This documentation explains how we create a microsimulation model that works at the constituency level. The system combines workplace surveys of jobs and earnings, HMRC tax records, and population statistics. We map data between 2010 and 2024 constituency boundaries, estimate income distributions, and optimize geographic weights.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"bDNkIaeGVn"}],"key":"MNjxFeo63g"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"This guide shows how to use PolicyEngine UK for constituency analysis. We start with data collection, transform it for modeling, and build tools to examine policies. The guide provides examples and code to implement these methods. Users can measure changes in household budgets, track employment, and understand economic patterns on different constituencies. This document starts with data collection from workplace surveys, tax records, and population counts, then explains how we convert this data into usable forms through income brackets and boundary mapping. It concludes with technical details about accuracy measurement and calibration, plus example code for analysis and visualization.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"LwtglAB3cZ"}],"key":"i5XNLoqGG2"}],"key":"HDot0n6dIJ"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Data","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Ee8QxvVeA5"}],"identifier":"data","label":"Data","html_id":"data","implicit":true,"key":"Ty8sR78lWK"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"In this section, we describe three main data sources that form the foundation of our constituency-level analysis: earning and jobs data from NOMIS ASHE, income statistics from HMRC, and population age distributions from the House of Commons Library.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"NZS0AR1Flu"}],"key":"mR87Hg21c9"},{"type":"heading","depth":3,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Earning and jobs data","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"NQqmyrrArO"}],"identifier":"earning-and-jobs-data","label":"Earning and jobs data","html_id":"earning-and-jobs-data","implicit":true,"key":"eoRGhKF5Di"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Data is extracted from NOMIS Annual Survey of Hours and Earnings (ASHE) - workplace analysis dataset, containing number of jobs and earnings percentiles for all UK parliamentary constituencies from the ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"SZ3Mbhakrw"},{"type":"link","url":"https://www.nomisweb.co.uk/datasets/ashe","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"NOMIS website","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"JCX6P7wDmE"}],"urlSource":"https://www.nomisweb.co.uk/datasets/ashe","key":"dbcXBtzeJn"},{"type":"text","value":". This dataset is stored as ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"BLTBtdxUw6"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/nomis_earning_jobs_data.xlsx","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"inlineCode","value":"nomis_earning_jobs_data.xlsx","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"WvUly66lQP"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/nomis_earning_jobs_data.xlsx","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/nomis_earning_jobs_data.xlsx","raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/nomis_earning_jobs_data.xlsx"},"internal":false,"protocol":"github","key":"ldKtOS6oEK"},{"type":"text","value":". To download the data, follow the variable selection process shown in the image below:","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"jlDlRpJZ3D"}],"key":"SPcIbowXyn"},{"type":"image","url":"/policyengine-uk-data/build/nomis_screenshot1-cd66b5d52b7084eee8b6167f26f0ee13.png","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"mUN55zBRw6","urlSource":"pictures/nomis_screenshot1.png"}],"key":"pFrfHmX86r"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Income data","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"hZGQbFBKee"}],"identifier":"income-data","label":"Income data","html_id":"income-data","implicit":true,"key":"jdpPOGoTXo"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Income data for UK parliamentary constituencies is obtained from ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"K8He6QHDWE"},{"type":"link","url":"https://www.gov.uk/government/statistics/income-and-tax-by-parliamentary-constituency-confidence-intervals","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"HMRC","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"pxhoSRLetf"}],"urlSource":"https://www.gov.uk/government/statistics/income-and-tax-by-parliamentary-constituency-confidence-intervals","key":"KZyVfjDH7U"},{"type":"text","value":". This dataset provides detailed information about income and tax by Parliamentary constituency with confidence intervals, and is stored as ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"G0eKN21WLn"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/total_income.csv","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"total_income.csv","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"voWYUgikOo"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/total_income.csv","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/total_income.csv","raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/total_income.csv"},"internal":false,"protocol":"github","key":"q3SPu8gWDD"},{"type":"text","value":", including two key variables:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"sn4zWi9hzL"}],"key":"RNLfldqhLv"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/total_income.csv#L1","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"inlineCode","value":"total_income_count","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"FCjK4tVDnW"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/total_income.csv#L1","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/total_income.csv","from":1,"raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/total_income.csv"},"internal":false,"protocol":"github","key":"Xf0E6vE08t"},{"type":"text","value":": the total number of taxpayers in each constituency","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"fZxstAAkNB"}],"key":"OfxpVg5GeO"}],"key":"xuzJ8oITV3"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/total_income.csv#L1","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"inlineCode","value":"total_income_amount","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"zQOiugTx3A"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/total_income.csv#L1","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/total_income.csv","from":1,"raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/total_income.csv"},"internal":false,"protocol":"github","key":"LYsL06H3vX"},{"type":"text","value":": the total amount of income for all taxpayers in each constituency","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"os3clzi0M9"}],"key":"KpUIPsgAei"}],"key":"fyIvrGNExE"}],"key":"SmquRgtW0m"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"We use these measures to identify similar constituencies when employment distribution data is missing. Our approach assumes that constituencies with similar income patterns (measured by both taxpayer counts and total income) will have similar earnings distributions. The following table shows the dataset:","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"r7REBdaf5t"}],"key":"MwHkjvrL6l"}],"key":"vekfAXVa1N"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import pandas as pd\nfrom itables import init_notebook_mode, show\nimport itables.options as opt\nopt.maxBytes = \"1MB\"\ninit_notebook_mode(all_interactive=True)\n\npd.read_csv(\"../policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/total_income.csv\")","key":"WsXJykaD72"},{"type":"output","id":"9P5qxdc_QLXLPRKucdJYq","data":[{"output_type":"display_data","metadata":{},"data":{"text/html":{"content":"<script>\n    let is_dark_theme = function () {\n        // Jupyter Lab\n        if ('jpThemeLight' in document.body.dataset)\n            return (document.body.dataset.jpThemeLight === \"false\");\n\n        // VS Code\n        if ('vscodeThemeKind' in document.body.dataset)\n            return document.body.dataset.vscodeThemeKind.includes('dark');\n\n        // Jupyter Book\n        if ('theme' in document.documentElement.dataset)\n            return document.documentElement.dataset.theme.includes('dark');\n\n        // Default\n        return window.matchMedia('(prefers-color-scheme: dark)').matches;\n    }\n\n    if (is_dark_theme()) {\n        document.documentElement.classList.add('dark');\n    }\n    else {\n        document.documentElement.classList.remove('dark');\n    }\n</script>\n","content_type":"text/html"},"text/plain":{"content":"<IPython.core.display.HTML object>","content_type":"text/plain"}}},{"output_type":"display_data","metadata":{},"data":{"text/html":{"content_type":"text/html","hash":"c6ab3fbdab1ff94600e51c14dfe3f701","path":"/policyengine-uk-data/build/c6ab3fbdab1ff94600e51c14dfe3f701.html"},"text/plain":{"content":"<IPython.core.display.HTML object>","content_type":"text/plain"}}},{"output_type":"execute_result","execution_count":22,"metadata":{},"data":{"text/html":{"content_type":"text/html","hash":"dfb915152674e94c00e70433737d2dfa","path":"/policyengine-uk-data/build/dfb915152674e94c00e70433737d2dfa.html"},"text/plain":{"content":"          code                       name  total_income_count  \\\n0    E14000530                  Aldershot             56000.0   \n1    E14000531        Aldridge-Brownhills             40000.0   \n2    E14000532   Altrincham and Sale West             53000.0   \n3    E14000533               Amber Valley             46000.0   \n4    E14000534    Arundel and South Downs             56000.0   \n..         ...                        ...                 ...   \n645  W07000076                 Caerphilly             38000.0   \n646  W07000077                     Islwyn             34000.0   \n647  W07000078          Vale of Glamorgan             51000.0   \n648  W07000079               Cardiff West             45000.0   \n649  W07000080  Cardiff South and Penarth             50000.0   \n\n     total_income_amount  \n0           1.999200e+09  \n1           1.312000e+09  \n2           3.180000e+09  \n3           1.389200e+09  \n4           2.665600e+09  \n..                   ...  \n645         1.193200e+09  \n646         9.656000e+08  \n647         1.810500e+09  \n648         1.647000e+09  \n649         1.640000e+09  \n\n[650 rows x 4 columns]","content_type":"text/plain"}}}],"key":"KUTkPkiKpm"}],"key":"AohZ125tA2"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Population data by age","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cNYPRk9Y31"}],"identifier":"population-data-by-age","label":"Population data by age","html_id":"population-data-by-age","implicit":true,"key":"uO4LodYd02"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Population data by age groups for UK parliamentary constituencies can be downloaded from the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"vNlKjip726"},{"type":"link","url":"https://commonslibrary.parliament.uk/constituency-statistics-population-by-age/","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"House of Commons Library data dashboard","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"SQNPUzC0li"}],"urlSource":"https://commonslibrary.parliament.uk/constituency-statistics-population-by-age/","key":"HaAy4M95fN"},{"type":"text","value":". The dataset provides detailed age breakdowns for each UK constituency, containing population counts for every age from 0 to 90+ years old across all parliamentary constituencies in England, Wales, Northern Ireland, and Scotland. The data is stored as ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ICPHsTgYid"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/age.csv","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"age.csv","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"oup2Mt317O"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/age.csv","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/age.csv","raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/age.csv"},"internal":false,"protocol":"github","key":"QkComO306E"},{"type":"text","value":". The following table shows the dataset:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"gqj2hIXs3d"}],"key":"IeafrJnFOC"}],"key":"y8SsaFUpfa"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import pandas as pd\nfrom itables import init_notebook_mode, show\nimport itables.options as opt\nopt.maxBytes = \"1MB\"\ninit_notebook_mode(all_interactive=True)\n\npd.read_csv(\"../policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/age.csv\")","key":"AV63wcGRfV"},{"type":"output","id":"YPmAp6q--Z5JUlHDRmIZp","data":[{"output_type":"display_data","metadata":{},"data":{"text/html":{"content":"<script>\n    let is_dark_theme = function () {\n        // Jupyter Lab\n        if ('jpThemeLight' in document.body.dataset)\n            return (document.body.dataset.jpThemeLight === \"false\");\n\n        // VS Code\n        if ('vscodeThemeKind' in document.body.dataset)\n            return document.body.dataset.vscodeThemeKind.includes('dark');\n\n        // Jupyter Book\n        if ('theme' in document.documentElement.dataset)\n            return document.documentElement.dataset.theme.includes('dark');\n\n        // Default\n        return window.matchMedia('(prefers-color-scheme: dark)').matches;\n    }\n\n    if (is_dark_theme()) {\n        document.documentElement.classList.add('dark');\n    }\n    else {\n        document.documentElement.classList.remove('dark');\n    }\n</script>\n","content_type":"text/html"},"text/plain":{"content":"<IPython.core.display.HTML object>","content_type":"text/plain"}}},{"output_type":"display_data","metadata":{},"data":{"text/html":{"content_type":"text/html","hash":"c6ab3fbdab1ff94600e51c14dfe3f701","path":"/policyengine-uk-data/build/c6ab3fbdab1ff94600e51c14dfe3f701.html"},"text/plain":{"content":"<IPython.core.display.HTML object>","content_type":"text/plain"}}},{"output_type":"execute_result","execution_count":21,"metadata":{},"data":{"text/html":{"content_type":"text/html","hash":"126dd4d9d2b312a8e2f92a04a8d3aeaa","path":"/policyengine-uk-data/build/126dd4d9d2b312a8e2f92a04a8d3aeaa.html"},"text/plain":{"content":"          code                       name       all       0       1       2  \\\n0    E14000530                  Aldershot  105168.0  1313.0  1401.0  1436.0   \n1    E14000531        Aldridge-Brownhills   77683.0   783.0   789.0   840.0   \n2    E14000532   Altrincham and Sale West  102444.0   943.0  1058.0  1130.0   \n3    E14000533               Amber Valley   92277.0   815.0   902.0   932.0   \n4    E14000534    Arundel and South Downs  102673.0   789.0   779.0   903.0   \n..         ...                        ...       ...     ...     ...     ...   \n645  W07000076                 Caerphilly   88586.0   886.0   906.0   979.0   \n646  W07000077                     Islwyn   76917.0   689.0   732.0   838.0   \n647  W07000078          Vale of Glamorgan  105094.0   976.0  1050.0  1165.0   \n648  W07000079               Cardiff West   94951.0  1116.0  1111.0  1132.0   \n649  W07000080  Cardiff South and Penarth  118913.0  1282.0  1277.0  1392.0   \n\n          3       4       5       6  ...     81     82     83     84     85  \\\n0    1294.0  1347.0  1491.0  1323.0  ...  513.0  455.0  449.0  362.0  317.0   \n1     784.0   822.0   908.0   897.0  ...  634.0  638.0  568.0  461.0  412.0   \n2    1198.0  1390.0  1287.0  1416.0  ...  610.0  557.0  511.0  455.0  436.0   \n3    1008.0   957.0   964.0   939.0  ...  562.0  515.0  466.0  409.0  350.0   \n4     938.0   984.0  1097.0  1052.0  ...  916.0  892.0  737.0  690.0  590.0   \n..      ...     ...     ...     ...  ...    ...    ...    ...    ...    ...   \n645  1029.0  1099.0  1053.0  1070.0  ...  491.0  477.0  387.0  363.0  334.0   \n646   789.0   836.0   872.0   852.0  ...  463.0  405.0  351.0  338.0  312.0   \n647  1261.0  1192.0  1271.0  1217.0  ...  656.0  592.0  531.0  447.0  389.0   \n648  1165.0  1236.0  1274.0  1284.0  ...  436.0  422.0  353.0  359.0  273.0   \n649  1406.0  1571.0  1511.0  1489.0  ...  516.0  513.0  405.0  421.0  355.0   \n\n        86     87     88     89     90+  \n0    322.0  230.0  186.0  179.0   802.0  \n1    348.0  333.0  319.0  253.0   922.0  \n2    376.0  346.0  311.0  292.0  1252.0  \n3    327.0  318.0  237.0  191.0   897.0  \n4    552.0  496.0  436.0  427.0  1562.0  \n..     ...    ...    ...    ...     ...  \n645  314.0  247.0  200.0  200.0   548.0  \n646  304.0  200.0  201.0  161.0   606.0  \n647  390.0  325.0  275.0  247.0   870.0  \n648  294.0  250.0  218.0  178.0   695.0  \n649  345.0  294.0  289.0  227.0   923.0  \n\n[650 rows x 94 columns]","content_type":"text/plain"}}}],"key":"j4IHUBkVXX"}],"key":"Gn7qkxJE90"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Preprocessing","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jGgMrhd8Fl"}],"identifier":"preprocessing","label":"Preprocessing","html_id":"preprocessing","implicit":true,"key":"xORlpVh6JG"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"In this section, we detail two key preprocessing steps necessary for our constituency-level analysis: converting earnings percentiles into practical income brackets, and mapping between different constituency boundary definitions (2010 to 2024).","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"FqR3R1kfIR"}],"key":"CtepS7uweR"},{"type":"heading","depth":3,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Convert earning percentiles to brackets","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"G3gbk9Q6xs"}],"identifier":"convert-earning-percentiles-to-brackets","label":"Convert earning percentiles to brackets","html_id":"convert-earning-percentiles-to-brackets","implicit":true,"key":"o5EMtNRE7A"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"To analyze earnings data effectively, we convert earning percentiles into earning brackets through the following process:","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"vFLDARNu6V"}],"key":"jcS79q5SsG"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":9,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"First, we estimate the full distribution of earnings by:","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"Xy8W1902kj"}],"key":"WG4Sx68Uez"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":10,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Using known percentile data (10th to 90th) from the ASHE dataset","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"TOabF2m6ay"}],"key":"kM1tIhUZqQ"}],"key":"ELK6KaiDXL"},{"type":"listItem","spread":true,"position":{"start":{"line":11,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Extending this to estimate the 90th-99th percentiles using ratios derived from ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"VkUh7aG5wb"},{"type":"link","url":"https://www.gov.uk/government/statistics/percentile-points-from-1-to-99-for-total-income-before-and-after-tax#:~:text=Details,in%20the%20Background%20Quality%20Report","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"this government statistics report","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"fg9WRfeRNC"}],"urlSource":"https://www.gov.uk/government/statistics/percentile-points-from-1-to-99-for-total-income-before-and-after-tax#:~:text=Details,in%20the%20Background%20Quality%20Report","key":"JUsquDzhxD"}],"key":"WOKnDY2zdv"}],"key":"BIaYIcgfAm"}],"key":"NK0kWCj5LW"}],"key":"Rdgivc1Hba"},{"type":"listItem","spread":true,"position":{"start":{"line":13,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"This estimation allows us to map earnings data into brackets that align with policy thresholds.","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"nazgwBNSSa"}],"key":"you4dkPihC"}],"key":"vORVGQaxlT"}],"key":"NKVlVsnV0N"},{"type":"paragraph","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"The following code and visualization demonstrate this process using an example constituency:","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"QUNJdiqtRM"}],"key":"KkM3KttNru"}],"key":"cunT8I1g5Z"},{"type":"block","kind":"notebook-content","children":[{"type":"code","lang":"python","value":"import pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\n\n# Sample data for Darlington\nincome_data = {\n    'parliamentary constituency 2010': ['Darlington'],\n    'constituency_code': ['E14000658'],\n    'Number of jobs': ['31000'],\n    '10 percentile': [13298.0],\n    '20 percentile': [16723.0],\n    '30 percentile': [20778.0],\n    '40 percentile': [23407.0],\n    '50 percentile': [27158.0],\n    '60 percentile': [30471.0],\n    '70 percentile': [33812.0],\n    '80 percentile': [40717.0],\n    '90 percentile': [55762.0],\n    '91 percentile': [58878.0],\n    '92 percentile': [62394.4],\n    '93 percentile': [66722.3],\n    '94 percentile': [71952.0],\n    '95 percentile': [78804.5],\n    '96 percentile': [87640.7],\n    '97 percentile': [100083.5],\n    '98 percentile': [123526.5],\n    '100 percentile': [179429.0]\n}\n\nincome_sample = pd.DataFrame(income_data)\n\n# Excel Data Method\ndef load_real_data():\n    # Read Excel data\n    income_real = pd.read_excel(\"nomis_earning_jobs_data.xlsx\", skiprows=7)\n    income_real.columns = income_real.iloc[0]\n    income_real = income_real.drop(index=0).reset_index(drop=True)\n    \n    # Select and rename columns\n    columns_to_keep = [\n        'parliamentary constituency 2010',\n        'constituency_code',\n        'Number of jobs',\n        'Median',\n        '10 percentile',\n        '20 percentile',\n        '30 percentile',\n        '40 percentile',\n        '60 percentile',\n        '70 percentile',\n        '80 percentile',\n        '90 percentile'\n    ]\n    income_real = income_real[columns_to_keep]\n    income_real = income_real.rename(columns={'Median': '50 percentile'})\n    return income_real\n\n# Plotting function\ndef plot_constituency_distribution(income_df, constituency_name, detailed=True):\n    constituency_data = income_df[income_df['parliamentary constituency 2010'] == constituency_name].iloc[0]\n    \n    percentiles = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 91, 92, 93, 94, 95, 96, 97, 98, 100]\n    income_values = [\n        0,\n        constituency_data['10 percentile'],\n        constituency_data['20 percentile'],\n        constituency_data['30 percentile'],\n        constituency_data['40 percentile'],\n        constituency_data['50 percentile'],\n        constituency_data['60 percentile'],\n        constituency_data['70 percentile'],\n        constituency_data['80 percentile'],\n        constituency_data['90 percentile'],\n        constituency_data['91 percentile'],\n        constituency_data['92 percentile'],\n        constituency_data['93 percentile'],\n        constituency_data['94 percentile'],\n        constituency_data['95 percentile'],\n        constituency_data['96 percentile'],\n        constituency_data['97 percentile'],\n        constituency_data['98 percentile'],\n        constituency_data['100 percentile']\n    ]\n    \n    valid_data = [(p, v) for p, v in zip(percentiles, income_values) if pd.notna(v)]\n    filtered_percentiles, filtered_income = zip(*valid_data)\n    \n    plt.figure(figsize=(8, 6))\n    plt.plot(filtered_percentiles, filtered_income, marker='o')\n    plt.xlabel('Percentiles')\n    plt.ylabel('Income')\n    plt.title(f'Income Distribution for {constituency_name}')\n    plt.grid(True)\n    plt.show()\n\n# Plot sample data (Darlington with detailed percentiles)\nplot_constituency_distribution(income_sample, 'Darlington', detailed=True)","key":"xnVPrFYBce"}],"key":"Aqb0cfqm5d"},{"type":"block","kind":"notebook-content","children":[{"type":"image","url":"/policyengine-uk-data/build/earning_dist-7afeddf7dd79edf5ead5d72b9d140c9c.png","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nSgM7Yge5M","urlSource":"pictures/earning_dist.png"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"After estimating the full earnings distribution, we convert the data into income brackets. We calculate the number of jobs and total earnings for each constituency and income bracket based on the estimated earnings distribution. When we encounter constituencies with missing data, we estimate their earnings distribution pattern using data from constituencies with similar total number of taxpayers and total income levels.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"FKbuGg3SCU"}],"key":"b7jHiWxhuJ"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"The Python script ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"HS3GWWPW55"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/create_employment_incomes.py","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"inlineCode","value":"create_employment_incomes.py","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"FLgkIQ3xEb"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/create_employment_incomes.py","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/create_employment_incomes.py","raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/create_employment_incomes.py"},"internal":false,"protocol":"github","key":"LlyIzJPzfH"},{"type":"text","value":" generates ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Q9eVTeYAIQ"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/employment_income.csv","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"inlineCode","value":"employment_income.csv","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"SDIpfCO9Nh"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/employment_income.csv","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/employment_income.csv","raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/employment_income.csv"},"internal":false,"protocol":"github","key":"Rh2ZbYj7KU"},{"type":"text","value":" containing number of jobs (","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"LIXuXrPSM8"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/employment_income.csv#L1","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"inlineCode","value":"employment_income_count","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"XGtKOBdwkn"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/employment_income.csv#L1","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/employment_income.csv","from":1,"raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/employment_income.csv"},"internal":false,"protocol":"github","key":"cyAeudPSx6"},{"type":"text","value":") and total earnings (","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"bwxbf34WIy"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/employment_income.csv#L1","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"inlineCode","value":"employment_income_amount","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"DTm4vLZlPN"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/employment_income.csv#L1","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/employment_income.csv","from":1,"raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/employment_income.csv"},"internal":false,"protocol":"github","key":"hu5v7hkNML"},{"type":"text","value":") for each constituency and income bracket. The following table shows employment and income across different brackets for constituencies:","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"A9A1YW9mbN"}],"key":"CUXOwZyS2h"}],"key":"EJod7Z8PPh"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import pandas as pd\nfrom itables import init_notebook_mode, show\nimport itables.options as opt\nopt.maxBytes = \"1MB\"\ninit_notebook_mode(all_interactive=True)\n\npd.read_csv(\"../policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/employment_income.csv\")","key":"iwvRSGuCOY"},{"type":"output","id":"1J_GhlP5XnCTy-AFM1sVt","data":[{"output_type":"display_data","metadata":{},"data":{"text/html":{"content":"<script>\n    let is_dark_theme = function () {\n        // Jupyter Lab\n        if ('jpThemeLight' in document.body.dataset)\n            return (document.body.dataset.jpThemeLight === \"false\");\n\n        // VS Code\n        if ('vscodeThemeKind' in document.body.dataset)\n            return document.body.dataset.vscodeThemeKind.includes('dark');\n\n        // Jupyter Book\n        if ('theme' in document.documentElement.dataset)\n            return document.documentElement.dataset.theme.includes('dark');\n\n        // Default\n        return window.matchMedia('(prefers-color-scheme: dark)').matches;\n    }\n\n    if (is_dark_theme()) {\n        document.documentElement.classList.add('dark');\n    }\n    else {\n        document.documentElement.classList.remove('dark');\n    }\n</script>\n","content_type":"text/html"},"text/plain":{"content":"<IPython.core.display.HTML object>","content_type":"text/plain"}}},{"output_type":"display_data","metadata":{},"data":{"text/html":{"content_type":"text/html","hash":"c6ab3fbdab1ff94600e51c14dfe3f701","path":"/policyengine-uk-data/build/c6ab3fbdab1ff94600e51c14dfe3f701.html"},"text/plain":{"content":"<IPython.core.display.HTML object>","content_type":"text/plain"}}},{"output_type":"execute_result","execution_count":20,"metadata":{},"data":{"text/html":{"content_type":"text/html","hash":"84217562928d92bca843d25e74fdbc99","path":"/policyengine-uk-data/build/84217562928d92bca843d25e74fdbc99.html"},"text/plain":{"content":"           code                       name  employment_income_lower_bound  \\\n0     E14000530                  Aldershot                         200000   \n1     E14000530                  Aldershot                         500000   \n2     E14000530                  Aldershot                         300000   \n3     E14000530                  Aldershot                              0   \n4     E14000530                  Aldershot                          12570   \n...         ...                        ...                            ...   \n8445  W07000080  Cardiff South and Penarth                         100000   \n8446  W07000080  Cardiff South and Penarth                         150000   \n8447  W07000080  Cardiff South and Penarth                         200000   \n8448  W07000080  Cardiff South and Penarth                              0   \n8449  W07000080  Cardiff South and Penarth                         500000   \n\n      employment_income_upper_bound  employment_income_count  \\\n0                          300000.0               660.099464   \n1                               inf                 0.000000   \n2                          500000.0                 0.000000   \n3                           12570.0              1073.632697   \n4                           15000.0               623.501391   \n...                             ...                      ...   \n8445                       150000.0              2510.857214   \n8446                       200000.0              1920.943459   \n8447                       300000.0                 0.000000   \n8448                        12570.0               700.837422   \n8449                            inf                 0.000000   \n\n      employment_income_amount  \n0                 1.650249e+08  \n1                 0.000000e+00  \n2                 0.000000e+00  \n3                 6.747782e+06  \n4                 8.594967e+06  \n...                        ...  \n8445              3.138572e+08  \n8446              3.361651e+08  \n8447              0.000000e+00  \n8448              4.404763e+06  \n8449              0.000000e+00  \n\n[8450 rows x 6 columns]","content_type":"text/plain"}}}],"key":"pCAgE9Hgyg"}],"key":"UPpagLaGq8"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Mapping constituencies from 2010 to 2024","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OZLdWB6Jo5"}],"identifier":"mapping-constituencies-from-2010-to-2024","label":"Mapping constituencies from 2010 to 2024","html_id":"mapping-constituencies-from-2010-to-2024","implicit":true,"key":"mayqNok054"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"PolicyEngine uses HMRC income data which aligns with 2010 constituency boundaries; to handle this issue and align it with 2024 constituency boundaries definitions, we follow these processes:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Q6GW8BYZFX"}],"key":"GK9N9z4zH8"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Download the mapping data from the ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"xbfhSx5ATb"},{"type":"link","url":"https://www.data.gov.uk/dataset/20c4ffe5-7d86-419f-808e-da98e46f4f52/westminster-pcon-may-2010-to-westminster-pcon-july-2024-lookup-in-the-uk-v2","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"ONS website","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"wjdBSY0Kaz"}],"urlSource":"https://www.data.gov.uk/dataset/20c4ffe5-7d86-419f-808e-da98e46f4f52/westminster-pcon-may-2010-to-westminster-pcon-july-2024-lookup-in-the-uk-v2","key":"jmJYA1cGGp"},{"type":"text","value":" that contains the official lookup table between 2010 and 2024 Westminster Parliamentary Constituencies.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"W0kBQ8THyH"}],"key":"CuTbaIljgF"}],"key":"geIPoJE74Y"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Create a mapping matrix (650 x 650) which maps each constituency from 2010 to corresponding constituency in 2024 using the ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"lL7U0GTjAJ"},{"type":"inlineCode","value":"boundary_changes/mapping_matrix.py","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"eMBUe1vaET"},{"type":"text","value":" script. This is a many-to-many mapping, as 2010 constituencies can be split across multiple 2024 constituencies, and 2024 constituencies can contain parts of multiple 2010 constituencies. The matrix structure has rows representing 2010 constituencies and columns representing 2024 constituencies.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"vGqAt477iV"}],"key":"U0uTsFghcp"}],"key":"zZNH1Dg6zC"},{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"For each row in the matrix (representing a 2010 constituency), normalize the weights so they sum to 1. This ensures that when we redistribute data from 2010 boundaries to 2024 boundaries, we maintain the correct proportions.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"OnhPaaWYrh"}],"key":"saCFdn2d4l"}],"key":"C7J4r8H1TL"}],"key":"zNdSw1RF3i"}],"key":"A6456Eujby"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Methodology","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JlVGsNOcj8"}],"identifier":"methodology","label":"Methodology","html_id":"methodology","implicit":true,"key":"O7nlRAI7wN"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"This section describes our approach to creating accurate constituency-level estimates through three key components: a loss function for evaluating accuracy, a calibration process for optimizing weights, and the mathematical framework behind the optimization. To see how well this methodology performs in practice, you can check our detailed ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"o48GdMpEmI"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/docs/validation/constituencies.ipynb","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"validation results page","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"OjtnTQryST"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/docs/validation/constituencies.ipynb","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"docs/validation/constituencies.ipynb","raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/docs/validation/constituencies.ipynb"},"internal":false,"protocol":"github","key":"RYNVs5ytNS"},{"type":"text","value":" comparing our estimates against actual data at both constituency and national levels.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"aRN1EdL7sZ"}],"key":"dBOP4awbR4"},{"type":"heading","depth":3,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Loss function","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"U0bFtKkQcj"}],"identifier":"loss-function","label":"Loss function","html_id":"loss-function","implicit":true,"key":"SiU1KosJL8"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"The file ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Oz3VGsFhQu"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"inlineCode","value":"loss.py","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"NNrke083XD"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py","raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py"},"internal":false,"protocol":"github","key":"Yi84BlpIVl"},{"type":"text","value":" defines a function ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"qJHB60bbh4"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py#L18","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"inlineCode","value":"create_constituency_target_matrix","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"W2qrICbO8u"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py#L18","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py","from":18,"raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py"},"internal":false,"protocol":"github","key":"HuWxnATJx6"},{"type":"text","value":" that creates target matrices for comparing simulated data against actual constituency-level data. The following process outlines how the function processes:","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Ia9KcCbL4O"}],"key":"KdbkoB9DPA"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":9,"column":1},"end":{"line":25,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Takes three main input parameters: dataset (defaults to ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"dWht7E4yIv"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py#L19","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"inlineCode","value":"enhanced_frs_2022_23","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"tldaMXEZ1V"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py#L19","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py","from":19,"raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py"},"internal":false,"protocol":"github","key":"zW1KQbyTjG"},{"type":"text","value":"), time_period (defaults to 2025), and an optional reform parameter for policy changes.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"ugiRBJfihV"}],"key":"Ivced5Au4m"}],"key":"C1VOkWTYuM"},{"type":"listItem","spread":true,"position":{"start":{"line":11,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"Reads three files containing real data: ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"ZEtb2z4ApS"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/age.csv","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"inlineCode","value":"age.csv","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"TSLUKnOos9"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/age.csv","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/age.csv","raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/age.csv"},"internal":false,"protocol":"github","key":"RKIlCYBaZa"},{"type":"text","value":", ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"OQQnQ2B7zD"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/total_income.csv","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"inlineCode","value":"total_income.csv","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"wLmsrHgFNZ"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/total_income.csv","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/total_income.csv","raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/total_income.csv"},"internal":false,"protocol":"github","key":"G9iHEVMFfc"},{"type":"text","value":", and ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"PV7MDymrUN"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/employment_income.csv","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"inlineCode","value":"employment_income.csv","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"Knmqlxogkf"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/employment_income.csv","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/employment_income.csv","raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/targets/employment_income.csv"},"internal":false,"protocol":"github","key":"H5cKMxvGCJ"},{"type":"text","value":".","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"bbKseiybJD"}],"key":"xaMlYjKklV"}],"key":"qQ1vrP1fe8"},{"type":"listItem","spread":true,"position":{"start":{"line":13,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"Creates a PolicyEngine Microsimulation object using the specified dataset and reform parameters.","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"sLwAJd9aUT"}],"key":"z0KktiGimA"}],"key":"XLvMO4k1h3"},{"type":"listItem","spread":true,"position":{"start":{"line":15,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"Creates two main matrices: ","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"ZaSaRmFOl7"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py#L33","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"inlineCode","value":"matrix","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"E0XiMdhQhx"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py#L33","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py","from":33,"raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py"},"internal":false,"protocol":"github","key":"nyVAdhU4jH"},{"type":"text","value":" for simulated values from PolicyEngine, and ","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"An6fzXQ4i8"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py#L34","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"inlineCode","value":"y","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"mrY3derauN"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py#L34","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py","from":34,"raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py"},"internal":false,"protocol":"github","key":"F76JOPsY8a"},{"type":"text","value":" for actual target values from both HMRC (income data) and ONS (age data).","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"nIV2lQmM5b"}],"key":"v45amO6ldJ"}],"key":"ZPvKVAD4g1"},{"type":"listItem","spread":true,"position":{"start":{"line":17,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"Calculates total income metrics at the national level, computing both total amounts and counts of people with income.","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"qdPvFH7SFE"}],"key":"Y6pZJi58x6"}],"key":"BRkyxOfCfw"},{"type":"listItem","spread":true,"position":{"start":{"line":19,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"text","value":"Processes age distributions by creating 10-year age bands from 0 to 80, calculating how many people fall into each band.","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"V6yoVkbT4u"}],"key":"cx6EWyer74"}],"key":"a8P6HNsRG0"},{"type":"listItem","spread":true,"position":{"start":{"line":21,"column":1},"end":{"line":22,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"text","value":"Processes both counts and amounts for different income bands between £12,570 and £70,000, excluding people under 16 for employment income.","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"Ol9Ipqrb08"}],"key":"GykNoDK4cU"}],"key":"wjiBSpAmIX"},{"type":"listItem","spread":true,"position":{"start":{"line":23,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"children":[{"type":"text","value":"Maps individual-level results to household level throughout the ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"kShrR23FPX"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py#L88","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"children":[{"type":"inlineCode","value":"sim.map_result()","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"zaJLyJpcdl"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py#L88","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py","from":88,"raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py"},"internal":false,"protocol":"github","key":"SNUPTckzIM"},{"type":"text","value":" function.","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"WFGub8SCqE"}],"key":"VN4hGKUEtz"}],"key":"QEk7GYVff0"},{"type":"listItem","spread":true,"position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"children":[{"type":"text","value":"The function returns both the simulated matrix and the target matrix ","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"MePDQSVDyO"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py#L34","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"children":[{"type":"inlineCode","value":"(matrix, y)","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"qf12VLO466"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py#L34","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py","from":34,"raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py"},"internal":false,"protocol":"github","key":"weGjNbv5P0"},{"type":"text","value":" which can be used for comparing the simulation results against actual data.","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"Cft0xXqrtc"}],"key":"vfEdoh9spN"}],"key":"LjcwlAkcY5"}],"key":"xUpQJr5gGv"}],"key":"kZ4lsQNDcu"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Calibration function","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qd8KV7woRB"}],"identifier":"calibration-function","label":"Calibration function","html_id":"calibration-function","implicit":true,"key":"boT3GXjmxv"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The file ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"z0WBzU75h2"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"calibrate.py","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"sZNO8BuJUt"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py","raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py"},"internal":false,"protocol":"github","key":"lBvr2almUo"},{"type":"text","value":" defines a main ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Pt8Aio9GqX"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py#L25","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"calibrate()","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"luOMLOo61Z"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py#L25","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py","from":25,"raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py"},"internal":false,"protocol":"github","key":"IeYU4wWFMX"},{"type":"text","value":" function that performs weight calibration for constituency-level analysis.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"IyP09iVFvj"}],"key":"nDA3lOxrvn"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"It imports necessary functions and matrices from other files including ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"GxiK0aQkQp"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py#L16","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"inlineCode","value":"create_constituency_target_matrix","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"NOyVfnPj1y"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py#L16","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py","from":16,"raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py"},"internal":false,"protocol":"github","key":"gEjF1fpd5D"},{"type":"text","value":", ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"gpwZReVB67"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py#L17","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"inlineCode","value":"create_national_target_matrix","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"DJsgMk3w9H"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py#L17","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py","from":17,"raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py"},"internal":false,"protocol":"github","key":"PNYFmLGOYs"},{"type":"text","value":" from ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"TH89bMl1bc"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"inlineCode","value":"loss.py","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"BSr0SDjh2I"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py","raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/loss.py"},"internal":false,"protocol":"github","key":"KrkmCXJfJs"},{"type":"text","value":", and ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"UNb9WTuWOz"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/transform_constituencies.py#L7","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"inlineCode","value":"transform_2010_to_2024","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"GoPAreaDQI"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/transform_constituencies.py#L7","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/transform_constituencies.py","from":7,"raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/transform_constituencies.py"},"internal":false,"protocol":"github","key":"y8aJ4DpT6J"},{"type":"text","value":" for constituency boundary transformations.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"KUPUsF8NhK"}],"key":"wxdh0VQvXN"}],"key":"bZuSIc6HTb"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Sets up initial matrices using the ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"ao5xK8FqHQ"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py#L26","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"inlineCode","value":"create_constituency_target_matrix","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"MPdw2zZtQR"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py#L26","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py","from":26,"raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py"},"internal":false,"protocol":"github","key":"ZC0RF4yH95"},{"type":"text","value":" and ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"EffiKaJQjT"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py#L28","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"inlineCode","value":"create_national_target_matrix","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"wpol1nBCTT"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py#L28","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py","from":28,"raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py"},"internal":false,"protocol":"github","key":"vMb8pkyrsY"},{"type":"text","value":" functions for both constituency and national level data.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"JGHqh0Rtxd"}],"key":"yA3FHKwiug"}],"key":"UXp1jXqRiE"},{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Creates a Microsimulation object using the ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"EWwUrNd1C0"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py#L32","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"inlineCode","value":"enhanced_frs_2022_23","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"aPmCGJuTZ0"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py#L32","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py","from":32,"raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py"},"internal":false,"protocol":"github","key":"X8L32NG90j"},{"type":"text","value":" dataset.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"QIFadeQBSv"}],"key":"K3a6L0kTOU"}],"key":"buHLGhS5oq"},{"type":"listItem","spread":true,"position":{"start":{"line":11,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"Initializes weights for 650 constituencies x 100180 households, starting with the log of household weights divided by constituency count.","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"EFBAdKMxbO"}],"key":"kKvog3Znud"}],"key":"QGxpMLhosX"},{"type":"listItem","spread":true,"position":{"start":{"line":13,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"Converts all the matrices and weights into PyTorch tensors to enable optimization.","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"QvIi5ePL9d"}],"key":"OAwm6qQl20"}],"key":"Uc54J81Lx7"},{"type":"listItem","spread":true,"position":{"start":{"line":15,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"Defines a loss function that calculates and combines both constituency-level and national-level mean squared errors into a single loss value.","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"GTlMgEFGix"}],"key":"DCakPEobc1"}],"key":"ulBKp6s0VH"},{"type":"listItem","spread":true,"position":{"start":{"line":17,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"Uses Adam optimizer with a learning rate of 0.1 to minimize the loss over 512 epochs.","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"W5Q8EsDssg"}],"key":"Mh2BRHjorn"}],"key":"Hwa4giaNzw"},{"type":"listItem","spread":true,"position":{"start":{"line":19,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"text","value":"Every 100 epochs during optimization, it updates the weights using the mapping matrix from 2010 to 2024 constituencies and saves the current weights to a ","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"F8azqnGmNG"},{"type":"inlineCode","value":"weights.h5","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"kN0WzQilPV"},{"type":"text","value":" file.","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"voPuw6WsSk"}],"key":"BSxn0ji3Wf"}],"key":"SVuVs6GQLj"},{"type":"listItem","spread":true,"position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"text","value":"Includes an ","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"GB1A7FERG4"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py#L95","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"inlineCode","value":"update_weights()","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"ZrWVhCg1dE"}],"urlSource":"https://github.com/PolicyEngine/policyengine-uk-data/blob/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py#L95","data":{"kind":"file","org":"PolicyEngine","repo":"policyengine-uk-data","reference":"7c782c4839a024c729350a3ff2c76922bf21b0d4","file":"policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py","from":95,"raw":"https://raw.githubusercontent.com/PolicyEngine/policyengine-uk-data/7c782c4839a024c729350a3ff2c76922bf21b0d4/policyengine_uk_data/datasets/frs/local_areas/constituencies/calibrate.py"},"internal":false,"protocol":"github","key":"AVe8PVjo4o"},{"type":"text","value":" function that applies the constituency mapping matrix to transform the weights between different boundary definitions.","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"aCLvcGUDwt"}],"key":"FyugxzKT68"}],"key":"Om8fuJIC2D"}],"key":"q392a0dzoE"}],"key":"qLrbU1iyAa"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Optimization mathematics","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uZPWHF6qwY"}],"identifier":"optimization-mathematics","label":"Optimization mathematics","html_id":"optimization-mathematics","implicit":true,"key":"RArj7Bj1LQ"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"In this part, we explain the mathematics behind the calibration process that we discussed above. The optimization uses a two-part loss function that balances constituency-level and national-level accuracy, combining both local and national targets into a single optimization problem. The mathematical formulation can be expressed as follows:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"OE0kWKrLoS"}],"key":"LKx8lCEAWw"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"For the constituency-level component, we have:","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"qBZBAYSqDP"}],"key":"MhlQee2e5L"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":6,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"A set of households (","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"JudNMSzLiw"},{"type":"inlineMath","value":"j","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>j</mi></mrow><annotation encoding=\"application/x-tex\">j</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.854em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span></span></span></span>","key":"jtCKz8pO0h"},{"type":"text","value":") with known characteristics (","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"LFU4mNW1xp"},{"type":"inlineMath","value":"metrics_j","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>m</mi><mi>e</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>c</mi><msub><mi>s</mi><mi>j</mi></msub></mrow><annotation encoding=\"application/x-tex\">metrics_j</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9456em;vertical-align:-0.2861em;\"></span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">c</span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span></span></span></span>","key":"DglN23k6Rw"},{"type":"text","value":") like income, age, etc.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"nbDMUPutSB"}],"key":"KwNitiYNSM"}],"key":"Z8nR8CZKf6"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"A set of constituencies (","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"kE9y0Gpukt"},{"type":"inlineMath","value":"i","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>i</mi></mrow><annotation encoding=\"application/x-tex\">i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6595em;\"></span><span class=\"mord mathnormal\">i</span></span></span></span>","key":"FL9AkA5IEA"},{"type":"text","value":") with known target values (","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"lkV9g7Duh1"},{"type":"inlineMath","value":"y_c","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>y</mi><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">y_c</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>","key":"LoOq8zq2EF"},{"type":"text","value":") from official statistics","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"yBP4XwLGpV"}],"key":"V0g24ZekO5"}],"key":"TSBAOFcu2N"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Weights in log space (","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"T307hQfSWZ"},{"type":"inlineMath","value":"w_{ij}","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>w</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">w_{ij}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">ij</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span></span></span></span>","key":"yO8GGVIOWA"},{"type":"text","value":") that we need to optimize for each household in each constituency","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"E5p8C8CZ1i"}],"key":"UIJ1wFUMZd"}],"key":"Q7EHMNwstX"}],"key":"hiULqDfpId"},{"type":"paragraph","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"Using these components, we calculate predicted constituency-level statistics. For each constituency metric (e.g. total income), the predicted value is:","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"OzaINTJaGe"}],"key":"MlZTm3swPK"},{"type":"math","value":"\\text{pred}_c = \\sum_j (\\exp(w_{ij}) \\times \\text{metrics}_j)","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"html":"<span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mtext>pred</mtext><mi>c</mi></msub><mo>=</mo><munder><mo>∑</mo><mi>j</mi></munder><mo stretchy=\"false\">(</mo><mi>exp</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><msub><mi>w</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy=\"false\">)</mo><mo>×</mo><msub><mtext>metrics</mtext><mi>j</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\text{pred}_c = \\sum_j (\\exp(w_{ij}) \\times \\text{metrics}_j)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9386em;vertical-align:-0.2441em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">pred</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.0573em;\"><span style=\"top:-2.4559em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2441em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.4638em;vertical-align:-1.4138em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.05em;\"><span style=\"top:-1.8723em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span><span style=\"top:-3.05em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4138em;\"><span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mop\">exp</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">ij</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0361em;vertical-align:-0.2861em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">metrics</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></span>","enumerator":"1","key":"selNaATs10"},{"type":"paragraph","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"where ","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"EhgZV0U59e"},{"type":"inlineMath","value":"\\text{metrics}_j","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mtext>metrics</mtext><mi>j</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\text{metrics}_j</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.954em;vertical-align:-0.2861em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">metrics</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span></span></span></span>","key":"bWSRA9bpi9"},{"type":"text","value":" represents the household-level characteristics for that specific metric (e.g. household income). We use exponential of weights to ensure they stay positive.","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"hUheuNjIa9"}],"key":"dHOVhZWGiL"},{"type":"paragraph","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"To measure how well our predictions match the real constituency data, we calculate the constituency mean squared error:","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"si4DJbE1bO"}],"key":"XrJwjRnkeS"},{"type":"math","value":"\\text{MSE}_c = \\text{mean}((\\text{pred}_c / (1 + y_c) - 1)^2)","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"html":"<span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mtext>MSE</mtext><mi>c</mi></msub><mo>=</mo><mtext>mean</mtext><mo stretchy=\"false\">(</mo><mo stretchy=\"false\">(</mo><msub><mtext>pred</mtext><mi>c</mi></msub><mi mathvariant=\"normal\">/</mi><mo stretchy=\"false\">(</mo><mn>1</mn><mo>+</mo><msub><mi>y</mi><mi>c</mi></msub><mo stretchy=\"false\">)</mo><mo>−</mo><mn>1</mn><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\text{MSE}_c = \\text{mean}((\\text{pred}_c / (1 + y_c) - 1)^2)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">MSE</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord text\"><span class=\"mord\">mean</span></span><span class=\"mopen\">((</span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">pred</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.0573em;\"><span style=\"top:-2.4559em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2441em;\"><span></span></span></span></span></span></span><span class=\"mord\">/</span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.1141em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></span>","enumerator":"2","key":"IxGWjsACTq"},{"type":"paragraph","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"text","value":"where ","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"ve3RhZxES2"},{"type":"inlineMath","value":"y_c","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>y</mi><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">y_c</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>","key":"rYSW8nmlLu"},{"type":"text","value":" are the actual target values from official statistics for each constituency. We use relative error (dividing by ","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"gWGlRbebvq"},{"type":"inlineMath","value":"1 + y_c","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn><mo>+</mo><msub><mi>y</mi><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">1 + y_c</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>","key":"z3txjmutUN"},{"type":"text","value":") to make errors comparable across different scales of metrics.","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"wg8xPnpUCt"}],"key":"WqZXg3hwWp"},{"type":"paragraph","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"children":[{"type":"text","value":"For the national component, we need to ensure our constituency-level adjustments don’t distort national-level statistics. We aggregate across all constituencies:","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"Y33ZTUUXTm"}],"key":"RZOSUiX491"},{"type":"math","value":"\\text{pred}_n = \\sum_i (\\sum_j \\exp(w_{ij})) \\times \\text{metrics}_\\text{national}","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"html":"<span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mtext>pred</mtext><mi>n</mi></msub><mo>=</mo><munder><mo>∑</mo><mi>i</mi></munder><mo stretchy=\"false\">(</mo><munder><mo>∑</mo><mi>j</mi></munder><mi>exp</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><msub><mi>w</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo><mo>×</mo><msub><mtext>metrics</mtext><mtext>national</mtext></msub></mrow><annotation encoding=\"application/x-tex\">\\text{pred}_n = \\sum_i (\\sum_j \\exp(w_{ij})) \\times \\text{metrics}_\\text{national}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9386em;vertical-align:-0.2441em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">pred</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.0573em;\"><span style=\"top:-2.4559em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2441em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.4638em;vertical-align:-1.4138em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.05em;\"><span style=\"top:-1.8723em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span><span style=\"top:-3.05em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.2777em;\"><span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.05em;\"><span style=\"top:-1.8723em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span><span style=\"top:-3.05em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4138em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mop\">exp</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">ij</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span><span class=\"mclose\">))</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8179em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">metrics</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">national</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></span>","enumerator":"3","key":"pStLtsMrrN"},{"type":"paragraph","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"children":[{"type":"text","value":"with corresponding mean squared error to measure deviation from national targets:","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"key":"wc4nseX1Md"}],"key":"tQ8LIzsxOc"},{"type":"math","value":"\\text{MSE}_n = \\text{mean}((\\text{pred}_n / (1 + y_n) - 1)^2)","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"html":"<span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mtext>MSE</mtext><mi>n</mi></msub><mo>=</mo><mtext>mean</mtext><mo stretchy=\"false\">(</mo><mo stretchy=\"false\">(</mo><msub><mtext>pred</mtext><mi>n</mi></msub><mi mathvariant=\"normal\">/</mi><mo stretchy=\"false\">(</mo><mn>1</mn><mo>+</mo><msub><mi>y</mi><mi>n</mi></msub><mo stretchy=\"false\">)</mo><mo>−</mo><mn>1</mn><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\text{MSE}_n = \\text{mean}((\\text{pred}_n / (1 + y_n) - 1)^2)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">MSE</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord text\"><span class=\"mord\">mean</span></span><span class=\"mopen\">((</span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">pred</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.0573em;\"><span style=\"top:-2.4559em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2441em;\"><span></span></span></span></span></span></span><span class=\"mord\">/</span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.1141em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></span>","enumerator":"4","key":"ZayLN8skbz"},{"type":"paragraph","position":{"start":{"line":30,"column":1},"end":{"line":30,"column":1}},"children":[{"type":"text","value":"The total loss combines both constituency and national errors:","position":{"start":{"line":30,"column":1},"end":{"line":30,"column":1}},"key":"ggizGwxxwq"}],"key":"pjjJSnYfl0"},{"type":"math","value":"L = \\text{MSE}_c + \\text{MSE}_n","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"html":"<span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>L</mi><mo>=</mo><msub><mtext>MSE</mtext><mi>c</mi></msub><mo>+</mo><msub><mtext>MSE</mtext><mi>n</mi></msub></mrow><annotation encoding=\"application/x-tex\">L = \\text{MSE}_c + \\text{MSE}_n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">L</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">MSE</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">MSE</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></span>","enumerator":"5","key":"hCcuws8z60"},{"type":"paragraph","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"children":[{"type":"text","value":"We initialize the weights using the original household weights from the survey data:","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"fZOX0XDc7F"}],"key":"l3qWwFc5T0"},{"type":"math","value":"w_{\\text{initial}} = \\ln(\\text{household}_{weight}/650)","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"html":"<span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mi>w</mi><mtext>initial</mtext></msub><mo>=</mo><mi>ln</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><msub><mtext>household</mtext><mrow><mi>w</mi><mi>e</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi></mrow></msub><mi mathvariant=\"normal\">/</mi><mn>650</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">w_{\\text{initial}} = \\ln(\\text{household}_{weight}/650)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5806em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">initial</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0361em;vertical-align:-0.2861em;\"></span><span class=\"mop\">ln</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">household</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">g</span><span class=\"mord mathnormal mtight\">h</span><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span><span class=\"mord\">/650</span><span class=\"mclose\">)</span></span></span></span></span>","enumerator":"6","key":"aky2szW6ZQ"},{"type":"paragraph","position":{"start":{"line":38,"column":1},"end":{"line":38,"column":1}},"children":[{"type":"text","value":"where 650 is the number of constituencies. These weights are then iteratively optimized using the Adam (Adaptive Moment Estimation) optimizer with a learning rate of 0.1. The optimization process runs for 512 epochs, with the weights being updated in each iteration:","position":{"start":{"line":38,"column":1},"end":{"line":38,"column":1}},"key":"tNU4S77KWy"}],"key":"eSXC6Xiwe8"},{"type":"math","value":"w_{t+1} = w_t - 0.1 \\times \\nabla L(w_t)","position":{"start":{"line":40,"column":1},"end":{"line":40,"column":1}},"html":"<span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mi>w</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><msub><mi>w</mi><mi>t</mi></msub><mo>−</mo><mn>0.1</mn><mo>×</mo><mi mathvariant=\"normal\">∇</mi><mi>L</mi><mo stretchy=\"false\">(</mo><msub><mi>w</mi><mi>t</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">w_{t+1} = w_t - 0.1 \\times \\nabla L(w_t)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6389em;vertical-align:-0.2083em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2083em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2806em;\"><span style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">0.1</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">∇</span><span class=\"mord mathnormal\">L</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2806em;\"><span style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></span>","enumerator":"7","key":"ibzAzwatgF"},{"type":"paragraph","position":{"start":{"line":42,"column":1},"end":{"line":42,"column":1}},"children":[{"type":"text","value":"This formulation ensures that the optimized weights maintain both local consistency at the constituency level and global accuracy for national-level statistics. The Adam optimizer adaptively adjusts the weights to minimize both constituency-level and national-level errors simultaneously, providing efficient convergence through adaptive learning rates and momentum. The resulting optimized weights allow us to accurately reweight household survey data to match both constituency-level and national statistics to obtain accurate estimates of income distributions, demographics, and policy impacts for each parliamentary constituency while maintaining consistency with national totals.","position":{"start":{"line":42,"column":1},"end":{"line":42,"column":1}},"key":"tz8Kd9K8kC"}],"key":"ep7IFh4xNO"}],"key":"P4EA0sqmV9"},{"type":"block","kind":"notebook-content","children":[{"type":"comment","value":" ![](pictures/parliamentary_earnings.png) ","key":"VBfhciDIkH"}],"key":"V9CTCeYANV"}],"key":"Hq5wHfcMUt"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Pension contributions","url":"/pension-contributions","group":"PolicyEngine UK data"},"next":{"title":"Local authority methodology","url":"/la-methodology","group":"PolicyEngine UK data"}}},"domain":"http://localhost:3000"}